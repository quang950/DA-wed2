<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Giỏ hàng</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    .cart-container {
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .cart-container h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #ddd;
      vertical-align: middle;
    }
    th {
      background-color: #007bff;
      color: #fff;
    }
    .remove-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      transition: background 0.3s;
      box-shadow: 0 2px 6px rgba(220,53,69,0.08);
    }
    .remove-btn:hover {
      background: #a71d2a;
      transform: scale(1.1);
    }
    td img {
      width: 100px;
      border-radius: 8px;
    }
    .remove-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .remove-btn:hover {
      background: #a71d2a;
    }
    .total {
      margin-top: 20px;
      text-align: right;
      font-size: 1.2rem;
      font-weight: bold;
    }
    .back-link {
      display: inline-block;
      margin-top: 20px;
      text-decoration: none;
      color: #007bff;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    .checkout-bar {
      margin-top: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .checkout-btn {
      background: #28a745;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }
    .checkout-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,0.12); }
  </style>
</head>
<body>
  <script>
    // Kiểm tra đăng nhập khi vào trang giỏ hàng
    document.addEventListener('DOMContentLoaded', function() {
      const isLoggedIn = localStorage.getItem('userLoggedIn') === 'true';
      if (!isLoggedIn) {
        // Hiển thị thông báo và chuyển hướng
        alert('Vui lòng đăng nhập để xem giỏ hàng!');
        window.location.href = 'login.html';
        return;
      }
    });
  </script>
  
  <div class="cart-container">
    <h2>Giỏ hàng của bạn</h2>
    <table id="cart-table">
      <thead>
        <tr>
          <th style="width:40px;"></th>
          <th style="width:100px;">Hình ảnh</th>
          <th>Tên xe</th>
          <th style="width:110px;">Giá</th>
          <th style="width:80px;">Số lượng</th>
          <th style="width:56px;"></th>
        </tr>
      </thead>
      <tbody id="cart-body">
        <!-- sản phẩm sẽ load bằng JS -->
      </tbody>
    </table>
    <div class="checkout-bar">
      <a href="index.html" class="back-link">← Tiếp tục mua sắm</a>
  <button id="ordersBtn" style="margin-left:16px;background:#007bff;color:#fff;border:none;padding:10px 18px;border-radius:6px;font-weight:600;cursor:pointer;">Đơn hàng đã mua</button>
      <button id="showOrderFormBtn" style="margin-left:16px;background:#28a745;color:#fff;border:none;padding:10px 18px;border-radius:6px;font-weight:600;cursor:pointer;">Đặt hàng</button>
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="total" id="cart-total">Tổng cộng: 0 VNĐ</div>
      </div>
    </div>
    <form id="orderForm" style="margin-top:32px;background:#f8f9fa;padding:24px 18px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.04);max-width:600px;margin-left:auto;margin-right:auto;">
  <h3 style="margin-bottom:18px;text-align:center;">Thông tin nhận hàng</h3>
    <script>
      // Ẩn form nhận hàng mặc định
      document.addEventListener('DOMContentLoaded', function() {
        var orderForm = document.getElementById('orderForm');
        var showOrderFormBtn = document.getElementById('showOrderFormBtn');
        if (orderForm) orderForm.style.display = 'none';
        if (showOrderFormBtn) {
          showOrderFormBtn.onclick = function() {
            var cart = JSON.parse(localStorage.getItem('cart')) || [];
            if (!cart.length) {
              alert('Giỏ hàng của bạn đang trống, vui lòng thêm sản phẩm trước khi đặt hàng');
              return;
            }
            orderForm.style.display = 'block';
            orderForm.scrollIntoView({behavior:'smooth',block:'center'});
          };
        }
      });
    </script>
      <div style="margin-bottom:16px;">
        <label><input type="radio" name="addressType" value="account" checked> Dùng địa chỉ từ tài khoản</label>
        <label style="margin-left:24px;"><input type="radio" name="addressType" value="new"> Nhập địa chỉ mới</label>
      </div>
      <div id="accountAddressFields" style="margin-bottom:16px;">
        <input type="text" id="accountName" placeholder="Họ tên" style="width:48%;margin-right:2%;padding:8px;border-radius:6px;border:1px solid #ccc;">
        <input type="text" id="accountPhone" placeholder="Điện thoại" style="width:48%;padding:8px;border-radius:6px;border:1px solid #ccc;">
        <input type="text" id="accountAddress" placeholder="Địa chỉ" style="width:100%;margin-top:8px;padding:8px;border-radius:6px;border:1px solid #ccc;">
      </div>
      <div id="newAddressFields" style="margin-bottom:16px;display:none;">
        <input type="text" id="newName" placeholder="Họ tên" style="width:48%;margin-right:2%;padding:8px;border-radius:6px;border:1px solid #ccc;">
        <input type="text" id="newPhone" placeholder="Điện thoại" style="width:48%;padding:8px;border-radius:6px;border:1px solid #ccc;">
        <input type="text" id="newAddress" placeholder="Địa chỉ" style="width:100%;margin-top:8px;padding:8px;border-radius:6px;border:1px solid #ccc;">
      </div>
      <div style="margin-bottom:16px;">
        <label><input type="radio" name="paymentType" value="cod" checked> Thanh toán khi nhận hàng (mặc định)</label>
        <label style="margin-left:24px;"><input type="radio" name="paymentType" value="bank"> Chuyển khoản</label>
        <label style="margin-left:24px;"><input type="radio" name="paymentType" value="online"> Thanh toán trực tuyến</label>
      </div>
      <button type="submit" class="checkout-btn" style="width:100%;margin-top:12px;">Đặt hàng</button>
    </form>
    <div id="orderSummary" style="display:none;margin-top:32px;background:#fff;padding:24px 18px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.04);max-width:600px;margin-left:auto;margin-right:auto;"></div>
    </div>
  </div>

  <script src="assets/js/main.js"></script>
  <script>
    // Hiển thị checkbox chọn xe trong giỏ và cập nhật tổng cộng
    document.addEventListener('DOMContentLoaded', function() {
      function renderCartWithCheckbox() {
        const tbody = document.getElementById('cart-body');
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        if (!tbody) return;
        if (!cart.length) {
          tbody.innerHTML = '<tr><td colspan="6">Giỏ hàng trống</td></tr>';
          document.getElementById('cart-total').textContent = 'Tổng cộng: 0 VNĐ';
          return;
        }
        let rows = '';
        cart.forEach((item, idx) => {
          rows += `<tr>
            <td><input type='checkbox' class='cart-select' data-idx='${idx}' checked></td>
            <td><img src='${item.img}' alt='${item.name}' style='width:70px;border-radius:8px;'></td>
            <td>${item.name}</td>
            <td>${item.price.toLocaleString('vi-VN')} VNĐ</td>
            <td>
              <div style='display:flex;flex-direction:column;align-items:center;gap:2px;'>
                <button class='qty-btn plus-btn' data-idx='${idx}' style='padding:2px 8px;border-radius:6px;background:#eee;border:none;font-size:1.2em;cursor:pointer;'>+</button>
                <span style='min-width:32px;display:inline-block;font-weight:600;'>${item.quantity}</span>
                <button class='qty-btn minus-btn' data-idx='${idx}' style='padding:2px 8px;border-radius:6px;background:#eee;border:none;font-size:1.2em;cursor:pointer;'>-</button>
              </div>
            </td>
            <td><button class='remove-btn' data-idx='${idx}' title='Xóa xe'><span style='font-size:1.2em;display:inline-block;vertical-align:middle;'>&#128465;</span></button></td>
          </tr>`;
        });
        tbody.innerHTML = rows;
        // Gán sự kiện cho nút tăng/giảm số lượng
        document.querySelectorAll('.qty-btn.minus-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const idx = Number(this.dataset.idx);
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            if (cart[idx].quantity > 1) {
              cart[idx].quantity--;
              localStorage.setItem('cart', JSON.stringify(cart));
              renderCartWithCheckbox();
            }
          });
        });
        document.querySelectorAll('.qty-btn.plus-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const idx = Number(this.dataset.idx);
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            cart[idx].quantity++;
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCartWithCheckbox();
          });
        });
        updateSelectedTotal();
        // Gán sự kiện cho checkbox để cập nhật tổng cộng
        document.querySelectorAll('.cart-select').forEach(cb => {
          cb.addEventListener('change', updateSelectedTotal);
        });
        // Gán sự kiện cho nút xóa xe
        document.querySelectorAll('.remove-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const idx = Number(this.dataset.idx);
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            cart.splice(idx, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCartWithCheckbox();
          });
        });
      }
      function updateSelectedTotal() {
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        const selectedIdx = Array.from(document.querySelectorAll('.cart-select:checked')).map(cb => Number(cb.dataset.idx));
        const selectedItems = cart.filter((item, idx) => selectedIdx.includes(idx));
        const total = selectedItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
        document.getElementById('cart-total').textContent = `Tổng cộng: ${total.toLocaleString('vi-VN')} VNĐ`;
      }
      renderCartWithCheckbox();
      // Ghi đè hàm đặt hàng để chỉ lấy xe được chọn
      var orderForm = document.getElementById('orderForm');
      if (orderForm) {
        orderForm.addEventListener('submit', function(e) {
          // Lấy xe được chọn
          const cart = JSON.parse(localStorage.getItem('cart')) || [];
          const selectedIdx = Array.from(document.querySelectorAll('.cart-select:checked')).map(cb => Number(cb.dataset.idx));
          const selectedItems = cart.filter((item, idx) => selectedIdx.includes(idx));
          if (!selectedItems.length) {
            alert('Vui lòng chọn ít nhất một xe để đặt hàng!');
            e.preventDefault();
            return false;
          }
          // Lấy thông tin nhận hàng
          let name, phone, address;
          if (document.querySelector('input[name="addressType"]:checked').value === 'account') {
            name = document.getElementById('accountName').value.trim();
            phone = document.getElementById('accountPhone').value.trim();
            address = document.getElementById('accountAddress').value.trim();
          } else {
            name = document.getElementById('newName').value.trim();
            phone = document.getElementById('newPhone').value.trim();
            address = document.getElementById('newAddress').value.trim();
          }
          // Lấy loại thanh toán
          const payment = document.querySelector('input[name="paymentType"]:checked').value;
          // Tính tổng tiền
          const total = selectedItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
          // Tạo đơn hàng mới chỉ với các xe đã chọn
          const orders = JSON.parse(localStorage.getItem('orders')) || [];
          orders.push({
            id: Date.now(),
            name,
            phone,
            address,
            payment,
            items: selectedItems,
            total,
            date: new Date().toLocaleString('vi-VN')
          });
          localStorage.setItem('orders', JSON.stringify(orders));
          // Xóa các xe đã đặt khỏi giỏ hàng
          const newCart = cart.filter((item, idx) => !selectedIdx.includes(idx));
          localStorage.setItem('cart', JSON.stringify(newCart));
          // Hiển thị thông báo thành công
          alert('Đặt hàng thành công!');
          window.open('orders.html', '_blank');
          // Cập nhật lại giỏ hàng
          renderCartWithCheckbox();
          e.preventDefault();
          return false;
        }, true);
      }
    });
  </script>
  <script>
    document.getElementById('ordersBtn').onclick = function() {
      window.open('orders.html', '_blank');
    };
  </script>
  <script>
    // Hiển thị địa chỉ từ tài khoản
    document.addEventListener('DOMContentLoaded', function() {
      function fillAccountAddress() {
        const email = localStorage.getItem('userEmail');
        let users = JSON.parse(localStorage.getItem('users')) || [];
        const user = users.find(u => u.email === email);
        document.getElementById('accountName').value = user?.firstName + ' ' + user?.lastName || '';
        document.getElementById('accountPhone').value = user?.phone || '';
        document.getElementById('accountAddress').value = user?.province || '';
      }
      fillAccountAddress();
      document.querySelectorAll('input[name="addressType"]').forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.value === 'account') {
            document.getElementById('accountAddressFields').style.display = '';
            document.getElementById('newAddressFields').style.display = 'none';
            fillAccountAddress();
          } else {
            document.getElementById('accountAddressFields').style.display = 'none';
            document.getElementById('newAddressFields').style.display = '';
          }
        });
      });
      // Đã xử lý đặt hàng ở script phía trên, không cần xử lý lại ở đây
    });
  </script>
</body>
</html>
